
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Handle concurrency Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="rule_lifetime.html" />
    
    
    <link rel="prev" href="dispatching_actions.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Readme
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../introduction/">
            
                <a href="../introduction/">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="./">
            
                <a href="./">
            
                    
                    Basic Concepts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="rule_definition.html">
            
                <a href="rule_definition.html">
            
                    
                    What is a rule
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="react_to_events.html">
            
                <a href="react_to_events.html">
            
                    
                    React to actions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="dispatching_actions.html">
            
                <a href="dispatching_actions.html">
            
                    
                    Dispatching actions
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.4" data-path="handle_concurrency.html">
            
                <a href="handle_concurrency.html">
            
                    
                    Handle concurrency
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="rule_lifetime.html">
            
                <a href="rule_lifetime.html">
            
                    
                    Set rule lifetime
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../advancedConcepts/">
            
                <a href="../advancedConcepts/">
            
                    
                    Advanced Concepts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../advancedConcepts/manipulating_actions.html">
            
                <a href="../advancedConcepts/manipulating_actions.html">
            
                    
                    Manipulating actions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../advancedConcepts/nest_rules.html">
            
                <a href="../advancedConcepts/nest_rules.html">
            
                    
                    Nesting rules
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../advancedConcepts/skip_rules.html">
            
                <a href="../advancedConcepts/skip_rules.html">
            
                    
                    skip rules
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../advancedConcepts/handle_streams.html">
            
                <a href="../advancedConcepts/handle_streams.html">
            
                    
                    Handling streams
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../advancedConcepts/cancel_rules.html">
            
                <a href="../advancedConcepts/cancel_rules.html">
            
                    
                    Cancel rules
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../advancedConcepts/handle_state_change.html">
            
                <a href="../advancedConcepts/handle_state_change.html">
            
                    
                    React to component state changes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="../advancedConcepts/how_it_works.html">
            
                <a href="../advancedConcepts/how_it_works.html">
            
                    
                    How it works
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="../advancedConcepts/devtools.html">
            
                <a href="../advancedConcepts/devtools.html">
            
                    
                    Devtools
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="../advancedConcepts/putting_all_together.html">
            
                <a href="../advancedConcepts/putting_all_together.html">
            
                    
                    Putting all together
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.10" data-path="../recipies/hold_back_action.html">
            
                <a href="../recipies/hold_back_action.html">
            
                    
                    Hold back action
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.11" data-path="../recipies/hydrate_state.html">
            
                <a href="../recipies/hydrate_state.html">
            
                    
                    Hydrate state
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../exports/">
            
                <a href="../exports/">
            
                    
                    exports
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../apiReference/">
            
                <a href="../apiReference/">
            
                    
                    API reference
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../apiReference/consequence.html">
            
                <a href="../apiReference/consequence.html">
            
                    
                    consequence
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1.1" data-path="../apiReference/consequence_action_return.html">
            
                <a href="../apiReference/consequence_action_return.html">
            
                    
                    Action return
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.2" data-path="../apiReference/consequence_promise_return.html">
            
                <a href="../apiReference/consequence_promise_return.html">
            
                    
                    Promise return
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.3" data-path="../apiReference/consequence_fn_return.html">
            
                <a href="../apiReference/consequence_fn_return.html">
            
                    
                    Function return
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../apiReference/saga.html">
            
                <a href="../apiReference/saga.html">
            
                    
                    addWhen/addUntil saga
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.2.1" data-path="../apiReference/saga_addWhen_return.html">
            
                <a href="../apiReference/saga_addWhen_return.html">
            
                    
                    addWhen return
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.2" data-path="../apiReference/saga_addUntil_return.html">
            
                <a href="../apiReference/saga_addUntil_return.html">
            
                    
                    addUntil return
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../apiReference/target.html">
            
                <a href="../apiReference/target.html">
            
                    
                    target
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../apiReference/condition.html">
            
                <a href="../apiReference/condition.html">
            
                    
                    condition
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../apiReference/concurrency.html">
            
                <a href="../apiReference/concurrency.html">
            
                    
                    concurrency
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="../apiReference/concurrencyFilter.html">
            
                <a href="../apiReference/concurrencyFilter.html">
            
                    
                    concurrencyFilter
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="../apiReference/debounce.html">
            
                <a href="../apiReference/debounce.html">
            
                    
                    debounce
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8" data-path="../apiReference/throttle.html">
            
                <a href="../apiReference/throttle.html">
            
                    
                    throttle
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9" data-path="../apiReference/weight.html">
            
                <a href="../apiReference/weight.html">
            
                    
                    weight
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.10" data-path="../apiReference/position.html">
            
                <a href="../apiReference/position.html">
            
                    
                    position
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.11" data-path="../apiReference/id.html">
            
                <a href="../apiReference/id.html">
            
                    
                    id
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.12" data-path="../apiReference/add_once.html">
            
                <a href="../apiReference/add_once.html">
            
                    
                    addOnce
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.13" data-path="../apiReference/delay.html">
            
                <a href="../apiReference/delay.html">
            
                    
                    delay
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Handle concurrency</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
                                <section class="normal markdown-section">
                                
                                <h1 id="handle-concurrency">Handle concurrency</h1>
<p>One of the hardest things in javascript is, how to handle concurrency. There are a lot of libs out there, that can help you with this. But it can still be really complex. One purpose of this middleware is to make concurrency handling as easy as possible. With just a few magic flags you can handle every common concurrency pattern. We distinguish two types of concurrencies:</p>
<ul>
<li><strong>Consequence concurrency</strong>: two consequences of the same rule run in parallel</li>
<li><strong>Rule concurrency</strong>: two rules are attached to the same action</li>
</ul>
<h2 id="consequence-concurrency">Consequence concurrency</h2>
<p>Concurrency happens everytime you do an async task. Everytime you fetch data, concurrency can be a problem. Most of the time we don&apos;t handle it properly, because it requires too much code for something, that maybe won&apos;t happen ever. But when a concurrency related problem happens, you have a problem. It can be really hard to debug, and won&apos;t happen evertime you try. So redux-ruleset tries to help you with a very simple api to handle concurrency. A rule has a special key <code>concurrency</code> where you can set your concurrency logic:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> {addRule} <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;redux-ruleset&apos;</span>

/**
Given a FETCH_PRODUCTS_REQUEST was dispatched
Then we fetch our products
and dispatch an action FETCH_PRODUCTS_SUCCESS with the result
*/
addRule({
  id: <span class="hljs-string">&apos;FETCH_PRODUCTS&apos;</span>,
  target: <span class="hljs-string">&apos;FETCH_PRODUCTS_REQUEST&apos;</span>,
  concurrency: <span class="hljs-string">&apos;SWITCH&apos;</span>, // when a later fetch resolves first, all previous ones will be canceled
  consequence: ({getState}) =&gt; {
    const state = getState()
    const filters = getProductListFilters(state.products)
    return api.fetchProducts(filters).then(
      result =&gt; ({ type: <span class="hljs-string">&apos;FETCH_PRODUCTS_SUCCESS&apos;</span>, payload: result }),
      error =&gt; ({ type: <span class="hljs-string">&apos;FETCH_PRODUCTS_FAILURE&apos;</span>, payload: error }),
    )
  }
})
</code></pre>
<p>In the above example we apply the SWITCH concurrency logic. If your familiar with rxjs, the redux-ruleset SWITCH logic works very similar to <code>.switch</code> operator of rxjs. Supose we dispatch a <code>FETCH_PRODUCT_REQUEST</code> twice right after another. For both actions we trigger the consequence. if the first consequence resolves first, we dispatch a <code>FETCH_PRODUCT_SUCCESS</code>, wait for the second consequence to resolve and dispatch another <code>FETCH_PRODUCT_SUCCESS</code>. If the second consequence resolves first, we dispatch <code>FETCH_PRODUCT_SUCCESS</code> and cancel the first consequence, so it cannot dispatch anymore. SWITCH only takes the latest consequence dispatch (or effect). </p>
<h5 id="concurrency-logics">concurrency logics</h5>
<p>There are many more concurrency patterns. </p>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>DEFAULT</td>
<td>no logic will be applied. default behaviour.</td>
</tr>
<tr>
<td>FIRST</td>
<td>as long as a consequence is running (did not resolve) no other consequence can start</td>
</tr>
<tr>
<td>LAST</td>
<td>as soon as the second consequence starts to execute, all previous consequences are canceled</td>
</tr>
<tr>
<td>ONCE</td>
<td>the consequence can only be called once during the lifetime of a rule. Only usefull when it comes to <a href="../advancedConcepts/nest_rules.html">rule-nesting</a></td>
</tr>
<tr>
<td>SWITCH</td>
<td>as soon as the second consequence dispatches (or triggers an effect) the first one will be canceled</td>
</tr>
<tr>
<td>ORDERED</td>
<td>if second rule dispatches (or triggers an effect) before first rule, it waits with the dispatch, until the first one dispatches</td>
</tr>
</tbody>
</table>
<h5 id="debounce-and-throttle">debounce and throttle</h5>
<p>For debouncing or throttling a rule&apos;s consequence you have seperate keys available:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> {addRule} <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;redux-ruleset&apos;</span>

addRule({
  ...,
  // wait 300 ms until the rule was executed last, then only execute the last call
  debounce: 300,
  concurrency: <span class="hljs-string">&apos;SWITCH&apos;</span>,
  consequence: () =&gt; /* do stuff */
})

addRule({
  ...,
  // wait 300 ms until the rule was executed first, then only execute the last call
  throttle: 300,
  concurrency: <span class="hljs-string">&apos;SWITCH&apos;</span>,
  consequence: () =&gt; /* do stuff */
})
</code></pre>
<p>Also you will have bigger time-windows with debounce and throttle, it is recommended to always set a concurrency since there can be a race-condition between the called consequences (but most of them are already canceled by debounce or throttle)</p>
<h5 id="refining-concurrency">refining concurrency</h5>
<p>Let&apos;s say we have an index <code>staticBlocks</code> where we store all our cms, we fetch from the server. This includes an action <code>FETCH_STATIC_BLOCK_REQUEST</code>, that triggers an fetch. </p>
<pre><code class="lang-javascript">type Action = {
  type: <span class="hljs-string">&apos;FETCH_STATIC_BLOCK_REQUEST&apos;</span>,
  meta: { identifier: string }
}
</code></pre>
<p>We don&apos;t want to fetch the same static block twice, but we want to fetch different static blocks in parallel. For this purpose we can refine the concurrency:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> {addRule} <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;redux-ruleset&apos;</span>

addRule({
  id: <span class="hljs-string">&apos;FETCH_STATIC_BLOCK&apos;</span>,
  target: <span class="hljs-string">&apos;FETCH_STATIC_BLOCK_REQUEST&apos;</span>,
  concurrencyFilter: action =&gt; action.meta.identifier, // concurrency only works for actions with same identifier
  concurrency: <span class="hljs-string">&apos;FIRST&apos;</span>, // <span class="hljs-keyword">as</span> long the a static block is fetching, the same static block cannot be fetched again
  consequence: ({action}) =&gt; api.fetchStaticBlock(action.meta.identifier).then(
    result =&gt; /* dispatch success */,
    error =&gt; /* dispatch error */
  )
})
</code></pre>
<p>In the above example we set a concurrency filter. The concurrency only matches for actions that resolve to the same concurrency filter. This is also true for debouncing or throttling. The concurrency-filter flag branches the execution of your consequence</p>
<h2 id="rule-concurrency">Rule concurrency</h2>
<p>A rule concurrency happens, when two or more rules are attached to the same target and the same position. you can define the order of execution by setting a weight:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> {addRule} <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;redux-ruleset&apos;</span>

addRule({
  id: <span class="hljs-string">&apos;EVENT_1&apos;</span>,
  target: <span class="hljs-string">&apos;ACTION&apos;</span>,
  weight: 2,
  consequence: () =&gt; console.log(<span class="hljs-string">&apos;event 1&apos;</span>)
})

addRule({
  id: <span class="hljs-string">&apos;EVENT_2&apos;</span>,
  target: <span class="hljs-string">&apos;ACTION&apos;</span>,
  weight: 1,
  consequence: () =&gt; console.log(<span class="hljs-string">&apos;event 2&apos;</span>)
})

dispatch({type: <span class="hljs-string">&apos;ACTION&apos;</span>})

// --&gt; event 2
// --&gt; event 1
</code></pre>
<p>The weight only manages the execution order of <code>consequences</code>. Everything else remains untouched. But that is ok, since the only place where the outer world can be changed is inside a consequence. If no rule has an weight, later added rules will be executed first. </p>

                                
                                </section>
                            
                        </div>
                    </div>
                
            </div>

            
                
                <a href="dispatching_actions.html" class="navigation navigation-prev " aria-label="Previous page: Dispatching actions">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="rule_lifetime.html" class="navigation navigation-next " aria-label="Next page: Set rule lifetime">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Handle concurrency","level":"1.3.4","depth":2,"next":{"title":"Set rule lifetime","level":"1.3.5","depth":2,"path":"docs/basicConcepts/rule_lifetime.md","ref":"docs/basicConcepts/rule_lifetime.md","articles":[]},"previous":{"title":"Dispatching actions","level":"1.3.3","depth":2,"path":"docs/basicConcepts/dispatching_actions.md","ref":"docs/basicConcepts/dispatching_actions.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{"maxIndexSize":1000000},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"docs/basicConcepts/handle_concurrency.md","mtime":"2019-04-21T20:13:42.019Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-09-28T19:32:03.502Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-search/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/buttons.js"></script>
        
    

    </body>
</html>

